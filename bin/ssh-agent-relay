#!/bin/bash

DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"
PREFIX=$(realpath $DIR/..)

if ! sc.exe query ssh-agent | grep 'RUNNING' > /dev/null; then
	echo "The Windows OpenSSH Agent isn't running, start it via 'net start ssh-agent'" >&2
	exit 1
fi

if ! which npiperelay.exe > /dev/null ; then
	WINUSER=$(cmd.exe /C "echo %USERNAME%" 2>/dev/null)
	cp $PREFIX/lib/ssh-agent-relay/npiperelay.exe "/mnt/$WINUSER/AppData/Local/Microsoft/WindowsApps"
fi

daemonize -p /tmp/ssh-relay.pid -l /tmp/ssh-relay.lock -- \
	/bin/socat UNIX-LISTEN:/tmp/ssh-relay-agent,fork,umask=007 EXEC:"npiperelay.exe -s -ep //./pipe/openssh-ssh-agent",nofork \
	> /dev/null 2>&1

AUTH_PID=$(cat /tmp/ssh-relay.pid)

echo "export SSH_AUTH_PID=$AUTH_PID"
echo "export SSH_AUTH_SOCK=/tmp/ssh-relay-agent"
